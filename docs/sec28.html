  <!DOCTYPE html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="generator" content="pandoc" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Gtk4 tutorial</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      pre{overflow: visible;}
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::after
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
          color: #aaaaaa;
        }
      pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
      code span.al { color: #ff0000; font-weight: bold; } /* Alert */
      code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
      code span.at { color: #7d9029; } /* Attribute */
      code span.bn { color: #40a070; } /* BaseN */
      code span.bu { } /* BuiltIn */
      code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
      code span.ch { color: #4070a0; } /* Char */
      code span.cn { color: #880000; } /* Constant */
      code span.co { color: #60a0b0; font-style: italic; } /* Comment */
      code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
      code span.do { color: #ba2121; font-style: italic; } /* Documentation */
      code span.dt { color: #902000; } /* DataType */
      code span.dv { color: #40a070; } /* DecVal */
      code span.er { color: #ff0000; font-weight: bold; } /* Error */
      code span.ex { } /* Extension */
      code span.fl { color: #40a070; } /* Float */
      code span.fu { color: #06287e; } /* Function */
      code span.im { } /* Import */
      code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
      code span.kw { color: #007020; font-weight: bold; } /* Keyword */
      code span.op { color: #666666; } /* Operator */
      code span.ot { color: #007020; } /* Other */
      code span.pp { color: #bc7a00; } /* Preprocessor */
      code span.sc { color: #4070a0; } /* SpecialChar */
      code span.ss { color: #bb6688; } /* SpecialString */
      code span.st { color: #4070a0; } /* String */
      code span.va { color: #19177c; } /* Variable */
      code span.vs { color: #4070a0; } /* VerbatimString */
      code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
      div.sourceCode { margin: 10px; padding: 16px 10px 8px 10px; border: 2px solid silver; background-color: ghostwhite; overflow-x:scroll}
      pre:not(.sourceCode) { margin: 10px; padding: 16px 10px 8px 10px; border: 2px solid silver; background-color: ghostwhite; overflow-x:scroll}
      table {margin-left: auto; margin-right: auto; border-collapse: collapse; border: 1px solid;}
      th {padding: 2px 6px; border: 1px solid; background-color: ghostwhite;}
      td {padding: 2px 6px; border: 1px solid;}
      img {display: block; margin-left: auto; margin-right: auto;}
      figcaption {text-align: center;}
    </style>
  </head>
  <body style="padding-top: 70px;">
    <div class="container">
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <span class="navbar-brand">Gtk4 tutorial</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
<a class="nav-link" href="index.html">Home</a>
</li>

            <li class="nav-item">
<a class="nav-link" href="sec27.html">Prev: section27</a>
</li>

            <li class="nav-item">
<a class="nav-link" href="sec29.html">Next: section29</a>
</li>

          </ul>
        </div>
      </div>
    </nav>
<h1 id="gtkexpression">GtkExpression</h1>
<p>GtkExpression is a fundamental type. It is not a descendant of GObject. GtkExpression provides a way to describe references to values. GtkExpression needs to be evaluated to obtain a value.</p>
<p>It is similar to arithmetic calculation.</p>
<pre><code>1 + 2 = 3</code></pre>
<p><code>1+2</code> is an expression. It shows the way how to calculate. <code>3</code> is the value comes from the expression. Evaluation is to calculate the expression and get the value.</p>
<p>GtkExpression is a way to get a value. Evaluation is like a calculation. A value is got by evaluating the expression.</p>
<p>First, I want to show you the C file of the example for GtkExpression. Its name is <code>exp.c</code> and located under src/expression directory. You don’t need to understand the details now, just look at it. It will be explained in the next subsection.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource C numberLines"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp">#include </span><span class="im">&lt;gtk/gtk.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>GtkWidget *win1;</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="dt">int</span> width, height;</span>
<span id="cb2-5"><a href="#cb2-5"></a>GtkExpressionWatch *watch_width;</span>
<span id="cb2-6"><a href="#cb2-6"></a>GtkExpressionWatch *watch_height;</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">/* Notify is called when &quot;default-width&quot; or &quot;default-height&quot; property is changed. */</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>notify (gpointer user_data) {</span>
<span id="cb2-11"><a href="#cb2-11"></a>  GValue value = G_VALUE_INIT;</span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="dt">char</span> *title;</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="cf">if</span> (watch_width &amp;&amp; gtk_expression_watch_evaluate (watch_width, &amp;value))</span>
<span id="cb2-15"><a href="#cb2-15"></a>    width = g_value_get_int (&amp;value);</span>
<span id="cb2-16"><a href="#cb2-16"></a>  g_value_unset (&amp;value);</span>
<span id="cb2-17"><a href="#cb2-17"></a>  <span class="cf">if</span> (watch_height &amp;&amp; gtk_expression_watch_evaluate (watch_height, &amp;value))</span>
<span id="cb2-18"><a href="#cb2-18"></a>    height = g_value_get_int (&amp;value);</span>
<span id="cb2-19"><a href="#cb2-19"></a>  g_value_unset (&amp;value);</span>
<span id="cb2-20"><a href="#cb2-20"></a>  title = g_strdup_printf (<span class="st">&quot;%d x %d&quot;</span>, width, height);</span>
<span id="cb2-21"><a href="#cb2-21"></a>  gtk_window_set_title (GTK_WINDOW (win1), title);</span>
<span id="cb2-22"><a href="#cb2-22"></a>  g_free (title);</span>
<span id="cb2-23"><a href="#cb2-23"></a>}</span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">/* This function is used by closure tag in exp.ui. */</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="dt">char</span> *</span>
<span id="cb2-27"><a href="#cb2-27"></a>set_title (GtkWidget *win, <span class="dt">int</span> width, <span class="dt">int</span> height) {</span>
<span id="cb2-28"><a href="#cb2-28"></a>  <span class="cf">return</span> g_strdup_printf (<span class="st">&quot;%d x %d&quot;</span>, width, height);</span>
<span id="cb2-29"><a href="#cb2-29"></a>}</span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">/* ----- activate, open, startup handlers ----- */</span></span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>app_activate (GApplication *application) {</span>
<span id="cb2-34"><a href="#cb2-34"></a>  GtkApplication *app = GTK_APPLICATION (application);</span>
<span id="cb2-35"><a href="#cb2-35"></a>  GtkWidget *box;</span>
<span id="cb2-36"><a href="#cb2-36"></a>  GtkWidget *label1, *label2, *label3;</span>
<span id="cb2-37"><a href="#cb2-37"></a>  GtkWidget *entry;</span>
<span id="cb2-38"><a href="#cb2-38"></a>  GtkEntryBuffer *buffer;</span>
<span id="cb2-39"><a href="#cb2-39"></a>  GtkBuilder *build;</span>
<span id="cb2-40"><a href="#cb2-40"></a>  GtkExpression *expression, *expression1, *expression2;</span>
<span id="cb2-41"><a href="#cb2-41"></a>  GValue value = G_VALUE_INIT;</span>
<span id="cb2-42"><a href="#cb2-42"></a>  <span class="dt">char</span> *s;</span>
<span id="cb2-43"><a href="#cb2-43"></a></span>
<span id="cb2-44"><a href="#cb2-44"></a>  <span class="co">/* Creates GtkApplicationWindow instance. */</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>  <span class="co">/* The codes below are complecated. It does the same as &quot;win1 = gtk_application_window_new (app);&quot;. */</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>  <span class="co">/* The codes are written just to show how to use GtkExpression. */</span></span>
<span id="cb2-47"><a href="#cb2-47"></a>  expression = gtk_cclosure_expression_new (GTK_TYPE_APPLICATION_WINDOW, NULL, <span class="dv">0</span>, NULL,</span>
<span id="cb2-48"><a href="#cb2-48"></a>                 G_CALLBACK (gtk_application_window_new), NULL, NULL);</span>
<span id="cb2-49"><a href="#cb2-49"></a>  <span class="cf">if</span> (gtk_expression_evaluate (expression, app, &amp;value)) {</span>
<span id="cb2-50"><a href="#cb2-50"></a>    win1 = GTK_WIDGET (g_value_get_object (&amp;value)); <span class="co">/* GtkApplicationWindow */</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>    g_object_ref (win1);</span>
<span id="cb2-52"><a href="#cb2-52"></a>    g_print (<span class="st">&quot;Got GtkApplicationWindow instance.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb2-53"><a href="#cb2-53"></a>  }<span class="cf">else</span></span>
<span id="cb2-54"><a href="#cb2-54"></a>    g_print (<span class="st">&quot;The cclosure expression wasn&#39;t evaluated correctly.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb2-55"><a href="#cb2-55"></a>  gtk_expression_unref (expression);</span>
<span id="cb2-56"><a href="#cb2-56"></a>  g_value_unset (&amp;value);    <span class="co">/* At the same time, the reference count of win1 is decreased by one. */</span></span>
<span id="cb2-57"><a href="#cb2-57"></a></span>
<span id="cb2-58"><a href="#cb2-58"></a>  <span class="co">/* Builds a window with components */</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>  box = gtk_box_new (GTK_ORIENTATION_VERTICAL, <span class="dv">10</span>);</span>
<span id="cb2-60"><a href="#cb2-60"></a>  label1 = gtk_label_new (NULL);</span>
<span id="cb2-61"><a href="#cb2-61"></a>  label2 = gtk_label_new (NULL);</span>
<span id="cb2-62"><a href="#cb2-62"></a>  label3 = gtk_label_new (NULL);</span>
<span id="cb2-63"><a href="#cb2-63"></a>  buffer = gtk_entry_buffer_new (NULL, <span class="dv">0</span>);</span>
<span id="cb2-64"><a href="#cb2-64"></a>  entry = gtk_entry_new_with_buffer (buffer);</span>
<span id="cb2-65"><a href="#cb2-65"></a>  gtk_box_append (GTK_BOX (box), label1);</span>
<span id="cb2-66"><a href="#cb2-66"></a>  gtk_box_append (GTK_BOX (box), label2);</span>
<span id="cb2-67"><a href="#cb2-67"></a>  gtk_box_append (GTK_BOX (box), label3);</span>
<span id="cb2-68"><a href="#cb2-68"></a>  gtk_box_append (GTK_BOX (box), entry);</span>
<span id="cb2-69"><a href="#cb2-69"></a>  gtk_window_set_child (GTK_WINDOW (win1), box);</span>
<span id="cb2-70"><a href="#cb2-70"></a></span>
<span id="cb2-71"><a href="#cb2-71"></a>  <span class="co">/* Constant expression */</span></span>
<span id="cb2-72"><a href="#cb2-72"></a>  expression = gtk_constant_expression_new (G_TYPE_INT,<span class="dv">100</span>);</span>
<span id="cb2-73"><a href="#cb2-73"></a>  <span class="cf">if</span> (gtk_expression_evaluate (expression, NULL, &amp;value)) {</span>
<span id="cb2-74"><a href="#cb2-74"></a>    s = g_strdup_printf (<span class="st">&quot;%d&quot;</span>, g_value_get_int (&amp;value));</span>
<span id="cb2-75"><a href="#cb2-75"></a>    gtk_label_set_text (GTK_LABEL (label1), s);</span>
<span id="cb2-76"><a href="#cb2-76"></a>    g_free (s);</span>
<span id="cb2-77"><a href="#cb2-77"></a>  } <span class="cf">else</span></span>
<span id="cb2-78"><a href="#cb2-78"></a>    g_print (<span class="st">&quot;The constant expression wasn&#39;t evaluated correctly.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb2-79"><a href="#cb2-79"></a>  gtk_expression_unref (expression);</span>
<span id="cb2-80"><a href="#cb2-80"></a>  g_value_unset (&amp;value);</span>
<span id="cb2-81"><a href="#cb2-81"></a></span>
<span id="cb2-82"><a href="#cb2-82"></a>  <span class="co">/* Property expression and binding*/</span></span>
<span id="cb2-83"><a href="#cb2-83"></a>  expression1 = gtk_property_expression_new (GTK_TYPE_ENTRY, NULL, <span class="st">&quot;buffer&quot;</span>);</span>
<span id="cb2-84"><a href="#cb2-84"></a>  expression2 = gtk_property_expression_new (GTK_TYPE_ENTRY_BUFFER, expression1, <span class="st">&quot;text&quot;</span>);</span>
<span id="cb2-85"><a href="#cb2-85"></a>  gtk_expression_bind (expression2, label2, <span class="st">&quot;label&quot;</span>, entry);</span>
<span id="cb2-86"><a href="#cb2-86"></a></span>
<span id="cb2-87"><a href="#cb2-87"></a>  <span class="co">/* Constant expression instead of &quot;this&quot; instance */</span></span>
<span id="cb2-88"><a href="#cb2-88"></a>  expression1 = gtk_constant_expression_new (GTK_TYPE_APPLICATION, app);</span>
<span id="cb2-89"><a href="#cb2-89"></a>  expression2 = gtk_property_expression_new (GTK_TYPE_APPLICATION, expression1, <span class="st">&quot;application-id&quot;</span>);</span>
<span id="cb2-90"><a href="#cb2-90"></a>  <span class="cf">if</span> (gtk_expression_evaluate (expression2, NULL, &amp;value))</span>
<span id="cb2-91"><a href="#cb2-91"></a>    gtk_label_set_text (GTK_LABEL (label3), g_value_get_string (&amp;value));</span>
<span id="cb2-92"><a href="#cb2-92"></a>  <span class="cf">else</span></span>
<span id="cb2-93"><a href="#cb2-93"></a>    g_print (<span class="st">&quot;The property expression wasn&#39;t evaluated correctly.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb2-94"><a href="#cb2-94"></a>  gtk_expression_unref (expression1); <span class="co">/* expression 2 is also freed. */</span></span>
<span id="cb2-95"><a href="#cb2-95"></a>  g_value_unset (&amp;value);</span>
<span id="cb2-96"><a href="#cb2-96"></a></span>
<span id="cb2-97"><a href="#cb2-97"></a>  width = <span class="dv">800</span>;</span>
<span id="cb2-98"><a href="#cb2-98"></a>  height = <span class="dv">600</span>;</span>
<span id="cb2-99"><a href="#cb2-99"></a>  gtk_window_set_default_size (GTK_WINDOW (win1), width, height);</span>
<span id="cb2-100"><a href="#cb2-100"></a>  notify(NULL);</span>
<span id="cb2-101"><a href="#cb2-101"></a></span>
<span id="cb2-102"><a href="#cb2-102"></a>  <span class="co">/* GtkExpressionWatch */</span></span>
<span id="cb2-103"><a href="#cb2-103"></a>  expression1 = gtk_property_expression_new (GTK_TYPE_WINDOW, NULL, <span class="st">&quot;default-width&quot;</span>);</span>
<span id="cb2-104"><a href="#cb2-104"></a>  watch_width = gtk_expression_watch (expression1, win1, notify, NULL, NULL);</span>
<span id="cb2-105"><a href="#cb2-105"></a>  expression2 = gtk_property_expression_new (GTK_TYPE_WINDOW, NULL, <span class="st">&quot;default-height&quot;</span>);</span>
<span id="cb2-106"><a href="#cb2-106"></a>  watch_height = gtk_expression_watch (expression2, win1, notify, NULL, NULL);</span>
<span id="cb2-107"><a href="#cb2-107"></a></span>
<span id="cb2-108"><a href="#cb2-108"></a>  gtk_widget_show (win1);</span>
<span id="cb2-109"><a href="#cb2-109"></a></span>
<span id="cb2-110"><a href="#cb2-110"></a>  <span class="co">/* Builds a window with exp.ui resource */</span></span>
<span id="cb2-111"><a href="#cb2-111"></a>  build = gtk_builder_new_from_resource (<span class="st">&quot;/com/github/ToshioCP/exp/exp.ui&quot;</span>);</span>
<span id="cb2-112"><a href="#cb2-112"></a>  GtkWidget *win2 = GTK_WIDGET (gtk_builder_get_object (build, <span class="st">&quot;win2&quot;</span>));</span>
<span id="cb2-113"><a href="#cb2-113"></a>  gtk_window_set_application (GTK_WINDOW (win2), app);</span>
<span id="cb2-114"><a href="#cb2-114"></a>  g_object_unref (build);</span>
<span id="cb2-115"><a href="#cb2-115"></a></span>
<span id="cb2-116"><a href="#cb2-116"></a>  gtk_widget_show (win2);</span>
<span id="cb2-117"><a href="#cb2-117"></a>}</span>
<span id="cb2-118"><a href="#cb2-118"></a></span>
<span id="cb2-119"><a href="#cb2-119"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb2-120"><a href="#cb2-120"></a>app_startup (GApplication *application) {</span>
<span id="cb2-121"><a href="#cb2-121"></a>}</span>
<span id="cb2-122"><a href="#cb2-122"></a></span>
<span id="cb2-123"><a href="#cb2-123"></a><span class="pp">#define APPLICATION_ID &quot;com.github.ToshioCP.exp&quot;</span></span>
<span id="cb2-124"><a href="#cb2-124"></a></span>
<span id="cb2-125"><a href="#cb2-125"></a><span class="dt">int</span></span>
<span id="cb2-126"><a href="#cb2-126"></a>main (<span class="dt">int</span> argc, <span class="dt">char</span> **argv) {</span>
<span id="cb2-127"><a href="#cb2-127"></a>  GtkApplication *app;</span>
<span id="cb2-128"><a href="#cb2-128"></a>  <span class="dt">int</span> stat;</span>
<span id="cb2-129"><a href="#cb2-129"></a></span>
<span id="cb2-130"><a href="#cb2-130"></a>  app = gtk_application_new (APPLICATION_ID, G_APPLICATION_FLAGS_NONE);</span>
<span id="cb2-131"><a href="#cb2-131"></a></span>
<span id="cb2-132"><a href="#cb2-132"></a>  g_signal_connect (app, <span class="st">&quot;startup&quot;</span>, G_CALLBACK (app_startup), NULL);</span>
<span id="cb2-133"><a href="#cb2-133"></a>  g_signal_connect (app, <span class="st">&quot;activate&quot;</span>, G_CALLBACK (app_activate), NULL);</span>
<span id="cb2-134"><a href="#cb2-134"></a><span class="co">/*  g_signal_connect (app, &quot;open&quot;, G_CALLBACK (app_open), NULL);*/</span></span>
<span id="cb2-135"><a href="#cb2-135"></a></span>
<span id="cb2-136"><a href="#cb2-136"></a>  stat =g_application_run (G_APPLICATION (app), argc, argv);</span>
<span id="cb2-137"><a href="#cb2-137"></a>  g_object_unref (app);</span>
<span id="cb2-138"><a href="#cb2-138"></a>  <span class="cf">return</span> stat;</span>
<span id="cb2-139"><a href="#cb2-139"></a>}</span></code></pre></div>
<p><code>exp.c</code> consists of five functions.</p>
<ul>
<li><code>notify</code></li>
<li><code>set_title</code></li>
<li><code>app_activate</code>. This is a handler of “activate” signal on GtkApplication instance.</li>
<li><code>app_startup</code>. This is a handler of “startup”signal. But nothing is done in this function.</li>
<li><code>main</code>.</li>
</ul>
<p>The function <code>app_activate</code> is an actual main body in <code>exp.c</code>.</p>
<h2 id="constant-expression">Constant expression</h2>
<p>Constant expression provides constant value or instance when it is evaluated.</p>
<ul>
<li>72-80: A constant expression. It is extracted and put into here.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>  expression = gtk_constant_expression_new (G_TYPE_INT,<span class="dv">100</span>);</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  <span class="cf">if</span> (gtk_expression_evaluate (expression, NULL, &amp;value)) {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    s = g_strdup_printf (<span class="st">&quot;%d&quot;</span>, g_value_get_int (&amp;value));</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>    gtk_label_set_text (GTK_LABEL (label1), s);</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>    g_free (s);</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>  } <span class="cf">else</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>    g_print (<span class="st">&quot;The constant expression wasn&#39;t evaluated correctly.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>  gtk_expression_unref (expression);</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>  g_value_unset (&amp;value);</span></code></pre></div>
<ul>
<li>Constant expression is created with <code>gtk_constant_expression_new</code> function. The parameter of the function is a type (GType) and a value (or instance).</li>
<li><code>gtk_expression_evaluate</code> evaluates the expression. It has three parameters, the expression to evaluate, <code>this</code> instance and GValue for being set with the value. <code>this</code> instance isn’t necessary for constant expressions. Therefore the second argument is NULL. <code>gtk_expression_evaluate</code> returns TRUE if it successfully evaluates the expression. Otherwise it returns FALSE.</li>
<li>If it returns TRUE, the GValue <code>value</code> is set with the value of the expression. The type of the value is int. <code>g_strdup_printf</code> converts the value to a string <code>s</code>.</li>
<li>GtkLabel <code>label1</code> is set with <code>s</code>. The string <code>s</code> needs to be freed.</li>
<li>If the evaluation fails a message is outputted to stderr.</li>
<li>The expression and GValue are freed.</li>
</ul>
<p>Constant expression is usually used to give a constant value or instance to another expression.</p>
<h2 id="property-expression">Property expression</h2>
<p>Property expression looks up a property in a GObject object. For example, a property expression that refers “label” property in GtkLabel object is created like this.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>expression = gtk_property_expression_new (GTK_TYPE_LABEL, another_expression, <span class="st">&quot;label&quot;</span>);</span></code></pre></div>
<p><code>another_expression</code> is expected to give a GtkLabel instance when it is evaluated. For example,</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>label = gtk_label_new (<span class="st">&quot;Hello&quot;</span>);</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>another_expression = gtk_constant_expression_new (GTK_TYPE_LABEL, label);</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>expression = gtk_property_expression_new (GTK_TYPE_LABEL, another_expression, <span class="st">&quot;label&quot;</span>);</span></code></pre></div>
<p>If <code>expression</code> is evaluated, the second parameter <code>another_expression</code> is evaluated in advance. The value of <code>another_expression</code> is <code>label</code> (GtkLabel instance). Then, <code>expression</code> looks up “label” property of <code>label</code> and the evaluation result is “Hello”.</p>
<p>In the example above, the second argument of <code>gtk_property_expression_new</code> is another expression. But the second argument can be NULL. If it is NULL, <code>this</code> instance is used instead. <code>this</code> is given by <code>gtk_expression_evaluate</code> function at the evaluation.</p>
<p>Now look at <code>exp.c</code>. The lines from 83 to 85 is extracted here.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>  expression1 = gtk_property_expression_new (GTK_TYPE_ENTRY, NULL, <span class="st">&quot;buffer&quot;</span>);</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>  expression2 = gtk_property_expression_new (GTK_TYPE_ENTRY_BUFFER, expression1, <span class="st">&quot;text&quot;</span>);</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>  gtk_expression_bind (expression2, label2, <span class="st">&quot;label&quot;</span>, entry);</span></code></pre></div>
<ul>
<li><code>expression1</code> looks up “buffer” property of <code>this</code> object, which is <code>GTK_TYPE_ENTRY</code> type.</li>
<li><code>expression2</code> looks up “text” property of GtkEntryBuffer object given by <code>epression1</code>.</li>
<li><code>gtk_expression_bind</code> binds a property to a value given by the expression. In this program, it binds a “label” property in <code>label2</code> to the value evaluated with <code>expresion2</code> with <code>entry</code> as <code>this</code> object. The evaluation process is as follows.
<ol type="1">
<li><code>expression2</code> is evaluated. But it includes <code>expression1</code> so <code>expression1</code> is evaluated in advance.</li>
<li>Because the second argument of <code>expression1</code> is NULL, <code>this</code> object is used. <code>this</code> is given by <code>gtk_expression_bind</code>. It is <code>entry</code> (GtkEntry instance). <code>expression1</code> looks up “buffer” property in <code>entry</code>. It is a GtkEntryBuffer instance <code>buffer</code>. (See line 64 in <code>exp.c</code>.)</li>
<li>Then, <code>expression2</code> looks up “text” property in <code>buffer</code>. It is a text held in <code>entry</code>.</li>
<li>The text is assigned to “label” property in <code>label2</code>.</li>
</ol></li>
<li><code>gtk_expression_bind</code> creates a GtkExpressionWatch. (But it isn’t assigned to a variable in the program above. If you want to keep the GtkExpressionWatch instance, assign it to a variable.)</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>  GtkExpressionWatch *watch;</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>  watch = gtk_expression_bind (expression2, label2, <span class="st">&quot;label&quot;</span>, entry);</span></code></pre></div>
<ul>
<li>Whenever the value from <code>expression2</code> changes, it evaluates <code>expression2</code> and set “label” property in <code>label2</code>. So, the change of the text in <code>entry</code> makes the “label” property reflect it immediately.</li>
</ul>
<h2 id="closure-expression">Closure expression</h2>
<p>Closure expression calls closure when it is evaluated. A closure is a generic representation of a callback (a pointer to a function). For information about closure, see <a href="https://docs.gtk.org/gobject/concepts.html#the-gobject-messaging-system">GObject API Reference, The GObject messaging system</a>. A closure expression is created with <code>gtk_cclosure_expression_new</code> function.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>GtkExpression *</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>gtk_cclosure_expression_new (GType value_type,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>                             GClosureMarshal marshal,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>                             guint n_params,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>                             GtkExpression **params,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>                             GCallback callback_func,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>                             gpointer user_data,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>                             GClosureNotify user_destroy);</span></code></pre></div>
<ul>
<li><code>value_type</code> is the type of the value when it is evaluated.</li>
<li><code>marshal</code> is a marshaller. You can assign NULL. If it is NULL, then <code>g_cclosure_marshal_generic ()</code> is used as a marshaller. It is a generic marshaller function implemented via libffi.</li>
<li><code>n_params</code> is the number of parameters.</li>
<li><code>params</code> points expressions for each parameter of the call back function.</li>
<li><code>callback_func</code> is a callback function.</li>
<li><code>user_data</code> is user data. You can add it for the closure. It is like <code>user_data</code> in <code>g_signal_connect</code>. If it is not necessary, assign NULL.</li>
<li><code>user_destroy</code> is a destroy notify for <code>user_data</code>. It is called to destroy <code>user_data</code> when it is no longer needed. If NULL is assigned to <code>user_data</code>, assign NULL to <code>user_destroy</code>, too.</li>
</ul>
<p>The following is extracted from <code>exp.c</code>. It is from line 47 to line 56.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>expression = gtk_cclosure_expression_new (GTK_TYPE_APPLICATION_WINDOW, NULL, <span class="dv">0</span>, NULL,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>               G_CALLBACK (gtk_application_window_new), NULL, NULL);</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a><span class="cf">if</span> (gtk_expression_evaluate (expression, app, &amp;value)) {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>  win1 = GTK_WIDGET (g_value_get_object (&amp;value)); <span class="co">/* GtkApplicationWindow */</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>  g_object_ref (win1);</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>  g_print (<span class="st">&quot;Got GtkApplicationWindow object.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>}<span class="cf">else</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>  g_print (<span class="st">&quot;The cclosure expression wasn&#39;t evaluated correctly.</span><span class="sc">\n</span><span class="st">&quot;</span>);</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>gtk_expression_unref (expression);</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>g_value_unset (&amp;value);    <span class="co">/* At the same time, the reference count of win1 is decreased by one. */</span></span></code></pre></div>
<p>The callback function is <code>gtk_application_window_new</code>. This function has one parameter which is an instance of GtkApplication. And it returns newly created GtkApplicationWindow instance. So, the first argument is <code>GTK_TYPE_APPLICATION_WINDOW</code> which is the type of the return value. The second argument is NULL so general marshaller <code>g_cclosure_marshal_generic ()</code> will be used. I think assigning NULL works in most cases when you program in C language.</p>
<p>The arguments given to the call back function are <code>this</code> object and parameters which are the fourth argument of <code>gtk_cclosure_expression_new</code>. So, the number of arguments is <code>n_params + 1</code>. Because <code>gtk_application_window_new</code> has one parameter, so <code>n_params</code> is zero and <code>**params</code> is NULL. No user data is necessary, so <code>user_data</code> and <code>user_destroy</code> are NULL.</p>
<p><code>gtk_expression_evaluate</code> evaluates the expression. <code>this</code> instance will be the first argument for <code>gtk_application_window_new</code>, so it is <code>app</code>.</p>
<p>If the evaluation succeeds, the GValue <code>value</code> holds a newly created GtkApplicationWindow instance. It is assigned to <code>win1</code>. The GValue will be unset when it is no longer used. And when it is unset, the GtkApplicationWindow instance will be released and its reference count will be decreased by one. It is necessary to increase the reference count by one in advance to keep the instance. <code>gtk_expression_unref</code> frees <code>expression</code> and <code>value</code> is unset.</p>
<p>As a result, we got a GtkApplicationWindow instance <code>win1</code>. We can do the same by:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>win1 = gtk_application_window_new (app);</span></code></pre></div>
<p>The example is more complicated and not practical than this one line code. The aim of the example is just to show how closure expression works.</p>
<p>Closure expression is flexible than other type of expression because you can specify your own callback function.</p>
<h2 id="gtkexpressionwatch">GtkExpressionWatch</h2>
<p>GtkExpressionWatch watches an expression and if the value of the expression changes it calls its notify handler.</p>
<p>The example uses GtkExpressionWatch in the line 103 to 106.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>expression1 = gtk_property_expression_new (GTK_TYPE_WINDOW, NULL, <span class="st">&quot;default-width&quot;</span>);</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>watch_width = gtk_expression_watch (expression1, win1, notify, NULL, NULL);</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>expression2 = gtk_property_expression_new (GTK_TYPE_WINDOW, NULL, <span class="st">&quot;default-height&quot;</span>);</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>watch_height = gtk_expression_watch (expression2, win1, notify, NULL, NULL);</span></code></pre></div>
<p>The expressions above refer to “default-width” and “default-height” properties of GtkWindow. The variable <code>watch_width</code> watches <code>expression1</code>. The second argument <code>win1</code> is <code>this</code> instance for <code>expression1</code>. So, <code>watch_width</code> watches the value of “default-width” property of <code>win1</code>. If the value changes, it calls <code>notify</code> handler. The fourth and fifth arguments are NULL because no user data is necessary.</p>
<p>The variable <code>watch_height</code> connects <code>notify</code> handler to <code>expression2</code>. So, <code>notiry</code> is also called when “default-height” changes.</p>
<p>The handler <code>norify</code> is as follows.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource C numberLines"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>notify (gpointer user_data) {</span>
<span id="cb12-3"><a href="#cb12-3"></a>  GValue value = G_VALUE_INIT;</span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="dt">char</span> *title;</span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="cf">if</span> (watch_width &amp;&amp; gtk_expression_watch_evaluate (watch_width, &amp;value))</span>
<span id="cb12-7"><a href="#cb12-7"></a>    width = g_value_get_int (&amp;value);</span>
<span id="cb12-8"><a href="#cb12-8"></a>  g_value_unset (&amp;value);</span>
<span id="cb12-9"><a href="#cb12-9"></a>  <span class="cf">if</span> (watch_height &amp;&amp; gtk_expression_watch_evaluate (watch_height, &amp;value))</span>
<span id="cb12-10"><a href="#cb12-10"></a>    height = g_value_get_int (&amp;value);</span>
<span id="cb12-11"><a href="#cb12-11"></a>  g_value_unset (&amp;value);</span>
<span id="cb12-12"><a href="#cb12-12"></a>  title = g_strdup_printf (<span class="st">&quot;%d x %d&quot;</span>, width, height);</span>
<span id="cb12-13"><a href="#cb12-13"></a>  gtk_window_set_title (GTK_WINDOW (win1), title);</span>
<span id="cb12-14"><a href="#cb12-14"></a>  g_free (title);</span>
<span id="cb12-15"><a href="#cb12-15"></a>}</span></code></pre></div>
<ul>
<li>6-11: Evaluates <code>expression1</code> and <code>expression2</code> with <code>expression_watch_evaluate</code> function.</li>
<li>12: Creates a string <code>title</code>. It contains the width and height, for example, “800 x 600”.</li>
<li>13: Sets the title of <code>win1</code> with the string <code>title</code>.</li>
</ul>
<p>The title of the window reflects the size of the window.</p>
<h2 id="exp.ui">exp.ui</h2>
<p><code>exp.c</code> builds a GtkWindow instance <code>win2</code> with <code>exp.ui</code>. The ui file <code>exp.ui</code> includes tags to create GtkExpressions. The tags are:</p>
<ul>
<li>constant tag to create constant expression</li>
<li>lookup tag to create property expression</li>
<li>closure tag to create closure expression</li>
<li>binding tag to bind a property to an expression</li>
</ul>
<p>The window <code>win2</code> behaves like <code>win1</code>. Because similar expressions are built with the ui file.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource xml numberLines"><code class="sourceCode xml"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw">&lt;interface&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkWindow&quot;</span><span class="ot"> id=</span><span class="st">&quot;win2&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>    <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;title&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>      <span class="kw">&lt;closure</span><span class="ot"> type=</span><span class="st">&quot;gchararray&quot;</span><span class="ot"> function=</span><span class="st">&quot;set_title&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>        <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;default-width&quot;</span><span class="ot"> type=</span><span class="st">&quot;GtkWindow&quot;</span><span class="kw">&gt;&lt;/lookup&gt;</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>        <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;default-height&quot;</span><span class="ot"> type=</span><span class="st">&quot;GtkWindow&quot;</span><span class="kw">&gt;&lt;/lookup&gt;</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>      <span class="kw">&lt;/closure&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="kw">&lt;/binding&gt;</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;default-width&quot;</span><span class="kw">&gt;</span>600<span class="kw">&lt;/property&gt;</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;default-height&quot;</span><span class="kw">&gt;</span>400<span class="kw">&lt;/property&gt;</span></span>
<span id="cb13-12"><a href="#cb13-12"></a>    <span class="kw">&lt;child&gt;</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>      <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkBox&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>        <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;orientation&quot;</span><span class="kw">&gt;</span>GTK_ORIENTATION_VERTICAL<span class="kw">&lt;/property&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>        <span class="kw">&lt;child&gt;</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>          <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkLabel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>            <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;label&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>              <span class="kw">&lt;constant</span><span class="ot"> type=</span><span class="st">&quot;gint&quot;</span><span class="kw">&gt;</span>100<span class="kw">&lt;/constant&gt;</span></span>
<span id="cb13-19"><a href="#cb13-19"></a>            <span class="kw">&lt;/binding&gt;</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>          <span class="kw">&lt;/object&gt;</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>        <span class="kw">&lt;/child&gt;</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>        <span class="kw">&lt;child&gt;</span></span>
<span id="cb13-23"><a href="#cb13-23"></a>          <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkLabel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-24"><a href="#cb13-24"></a>            <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;label&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>              <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;text&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-26"><a href="#cb13-26"></a>                <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;buffer&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-27"><a href="#cb13-27"></a>                  entry</span>
<span id="cb13-28"><a href="#cb13-28"></a>                <span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb13-29"><a href="#cb13-29"></a>              <span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb13-30"><a href="#cb13-30"></a>            <span class="kw">&lt;/binding&gt;</span></span>
<span id="cb13-31"><a href="#cb13-31"></a>          <span class="kw">&lt;/object&gt;</span></span>
<span id="cb13-32"><a href="#cb13-32"></a>        <span class="kw">&lt;/child&gt;</span></span>
<span id="cb13-33"><a href="#cb13-33"></a>        <span class="kw">&lt;child&gt;</span></span>
<span id="cb13-34"><a href="#cb13-34"></a>          <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkLabel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-35"><a href="#cb13-35"></a>            <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;label&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-36"><a href="#cb13-36"></a>              <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;application-id&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-37"><a href="#cb13-37"></a>                <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;application&quot;</span><span class="kw">&gt;</span>win2<span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb13-38"><a href="#cb13-38"></a>              <span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb13-39"><a href="#cb13-39"></a>            <span class="kw">&lt;/binding&gt;</span></span>
<span id="cb13-40"><a href="#cb13-40"></a>          <span class="kw">&lt;/object&gt;</span></span>
<span id="cb13-41"><a href="#cb13-41"></a>        <span class="kw">&lt;/child&gt;</span></span>
<span id="cb13-42"><a href="#cb13-42"></a>        <span class="kw">&lt;child&gt;</span></span>
<span id="cb13-43"><a href="#cb13-43"></a>          <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkEntry&quot;</span><span class="ot"> id=</span><span class="st">&quot;entry&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-44"><a href="#cb13-44"></a>            <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;buffer&quot;</span><span class="kw">&gt;</span></span>
<span id="cb13-45"><a href="#cb13-45"></a>              <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkEntryBuffer&quot;</span><span class="kw">&gt;&lt;/object&gt;</span></span>
<span id="cb13-46"><a href="#cb13-46"></a>            <span class="kw">&lt;/property&gt;</span></span>
<span id="cb13-47"><a href="#cb13-47"></a>          <span class="kw">&lt;/object&gt;</span></span>
<span id="cb13-48"><a href="#cb13-48"></a>        <span class="kw">&lt;/child&gt;</span></span>
<span id="cb13-49"><a href="#cb13-49"></a>      <span class="kw">&lt;/object&gt;</span></span>
<span id="cb13-50"><a href="#cb13-50"></a>    <span class="kw">&lt;/child&gt;</span></span>
<span id="cb13-51"><a href="#cb13-51"></a>  <span class="kw">&lt;/object&gt;</span></span>
<span id="cb13-52"><a href="#cb13-52"></a><span class="kw">&lt;/interface&gt;</span></span></code></pre></div>
<h3 id="constant-tag">Constant tag</h3>
<p>A constant tag corresponds to a constant expression.</p>
<ul>
<li>18: Constant tag. The constant expression is created with the tag. It returns 100, the type is “gint”, when it is evaluated. The type “gint” is a name of <code>G_TYPE_INT</code> type. Similarly, the types which is registered to the type system has type and name. For example, “gchararray” is a name of <code>G_TYPE_STRING</code> type. You need to use the name of types for the <code>type</code>attribute. See <a href="https://github.com/ToshioCP/Gobject-tutorial/blob/main/gfm/sec5.md#gvalue">GObject tutorial</a>.</li>
<li>17-19: Binding tag corresponds to <code>gtk_expression_bind</code> function. <code>name</code> attribute specifies the “label” property of the GtkLabel object just before the binding tag. The expression returns a int type GValue. On the other hand “label” property holds a string type GValue. When a GValue is copied to another GValue, the type is automatically converted if possible. In this case, an int <code>100</code> is converted to a string <code>"100"</code>.</li>
</ul>
<p>These binding and constant tag works. But they are not good. A property tag is more straightforward.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkLabel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>  <span class="kw">&lt;property</span><span class="ot"> name=</span><span class="st">&quot;label&quot;</span><span class="kw">&gt;</span>100<span class="kw">&lt;/property&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a><span class="kw">&lt;/object&gt;</span></span></code></pre></div>
<p>This example just shows the way how to use constant tag. Constant tag is mainly used to give a constant argument to a closure.</p>
<h3 id="lookup-tag">Lookup tag</h3>
<p>A lookup tag corresponds to a property expression. Line 23 to 31 is copied here.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>          <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkLabel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>            <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;label&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>              <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;text&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>                <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;buffer&quot;</span><span class="kw">&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>                  entry</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>                <span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>              <span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a>            <span class="kw">&lt;/binding&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a>          <span class="kw">&lt;/object&gt;</span></span></code></pre></div>
<ul>
<li>binding tag binds a “label” property in GtkLabel to an expression. The expression is defined with a lookup tag.</li>
<li>The lookup tag defines a property expression looks up a “text” property in the instance which is defined in the next expression. The next expression is created with the lookup tag. The expression looks up the <code>buffer</code> property of the <code>entry</code> instance. The <code>entry</code> instance is defined in the line 43. It is a GtkEntry <code>entry</code>. A lookup tag takes an instance in some ways to look up for a property.
<ul>
<li>If it has no contents, it takes <code>this</code> instance when it is evaluated.</li>
<li>If it has a content of a tag for an expression, which is constant, lookup or closure tag, the value of the expression will be the instance to look up when it is evaluated.</li>
<li>If it has a content of an id of an object, then the instance of the object will be taken as the instance to lookup.</li>
</ul></li>
</ul>
<p>As a result, the label of the GtkLabel instance are bound to the text in the field of GtkEntry. If a user input a text in the field in the GtkEntry, GtkLabel displays the same text.</p>
<p>Another lookup tag is in the lines from 34 to 40.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>          <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkLabel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>            <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;label&quot;</span><span class="kw">&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>              <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;application-id&quot;</span><span class="kw">&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>                <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;application&quot;</span><span class="kw">&gt;</span>win2<span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>              <span class="kw">&lt;/lookup&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>            <span class="kw">&lt;/binding&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>          <span class="kw">&lt;/object&gt;</span></span></code></pre></div>
<ul>
<li>Two expressions are nested.</li>
<li>A lookup tag looks up “application-id” property of the next expression.</li>
<li>The next lookup tag looks up “application” property of <code>win2</code> instance.</li>
</ul>
<p>As a result, the “label” property in the GtkLabel instance is bound to the “application-id” property. The nested tag makes a chain like:</p>
<pre><code>&quot;label&quot; &lt;= &quot;application-id&quot; &lt;= &quot;application&quot; &lt;= `win2`</code></pre>
<p>By the way, the application of <code>win2</code> is set after the objects in ui file are built. Look at <code>exp.c</code>. <code>gtk_window_set_application</code> is called after <code>gtk_build_new_from_resource</code>.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>build = gtk_builder_new_from_resource (<span class="st">&quot;/com/github/ToshioCP/exp/exp.ui&quot;</span>);</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>GtkWidget *win2 = GTK_WIDGET (gtk_builder_get_object (build, <span class="st">&quot;win2&quot;</span>));</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>gtk_window_set_application (GTK_WINDOW (win2), app);</span></code></pre></div>
<p>Therefore, before the call for <code>gtk_window_set_application</code>, the “application” property of <code>win2</code> is <em>not</em> set. So, the evaluation of <code>&lt;lookup name="application"&gt;win2&lt;/lookup&gt;</code> fails. And the evaluation of <code>&lt;lookup name="application-id"&gt;</code> also fails. A function <code>gtk_expression_bind ()</code>, which corresponds to <code>binding</code> tag, doesn’t update the target property if the expression fails. So, the “label” property isn’t updated at the first evaluation.</p>
<p>Note that an evaluation can fail. The care is especially necessary when you write a callback for a closure tag which has contents of expressions like lookup tags. The expressions are given to the callback as an argument. If an expression fails the argument will be NULL. You need to check if the argument exactly points the instance that is expected by the callback.</p>
<h3 id="closure-tag">Closure tag</h3>
<p>The lines from 3 to 9 include a closure tag.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>  <span class="kw">&lt;object</span><span class="ot"> class=</span><span class="st">&quot;GtkWindow&quot;</span><span class="ot"> id=</span><span class="st">&quot;win2&quot;</span><span class="kw">&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>    <span class="kw">&lt;binding</span><span class="ot"> name=</span><span class="st">&quot;title&quot;</span><span class="kw">&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>      <span class="kw">&lt;closure</span><span class="ot"> type=</span><span class="st">&quot;gchararray&quot;</span><span class="ot"> function=</span><span class="st">&quot;set_title&quot;</span><span class="kw">&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>        <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;default-width&quot;</span><span class="ot"> type=</span><span class="st">&quot;GtkWindow&quot;</span><span class="kw">&gt;&lt;/lookup&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>        <span class="kw">&lt;lookup</span><span class="ot"> name=</span><span class="st">&quot;default-height&quot;</span><span class="ot"> type=</span><span class="st">&quot;GtkWindow&quot;</span><span class="kw">&gt;&lt;/lookup&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>      <span class="kw">&lt;/closure&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    <span class="kw">&lt;/binding&gt;</span></span></code></pre></div>
<ul>
<li>A binding tag corresponds to a <code>gtk_expression_bind</code> function. <code>name</code> attribute specifies the “title” property of <code>win2</code>. Binding tag gives <code>win2</code> as the <code>this</code> instance to the expressions, which are the contents of the binding tag. So, closure tag and lookup tags use <code>win2</code> as the <code>this</code> object when they are evaluated.</li>
<li>A closure tag corresponds to a closure expression. Its callback function is <code>set_title</code> and it returns “gchararray” type, which is “an array of characters” i.e. a string. The contents of the closure tag are assigned to parameters of the function. So, <code>set_title</code> has three parameters, <code>win2</code> (<code>this</code> instance), default width and default height.</li>
<li>Lookup tags correspond to property expressions. They lookup “default-width” and “default-height” properties of <code>win2</code> (<code>this</code> instance).</li>
<li>Binding tab creates GtkExpressionWatch automatically, so “title” property reflects the changes of “default-width” and “default-height” properties.</li>
</ul>
<p><code>set_title</code> function in <code>exp.c</code> is as follows.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource C numberLines"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1"></a><span class="dt">char</span> *</span>
<span id="cb20-2"><a href="#cb20-2"></a>set_title (GtkWidget *win, <span class="dt">int</span> width, <span class="dt">int</span> height) {</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="cf">return</span> g_strdup_printf (<span class="st">&quot;%d x %d&quot;</span>, width, height);</span>
<span id="cb20-4"><a href="#cb20-4"></a>}</span></code></pre></div>
<p>It just creates a string, for example, “800 x 600”, and returns it.</p>
<p>You’ve probably been noticed that ui file is easier and clearer than the corresponding C program. One of the most useful case of GtkExpression is building GtkListItem instance with GtkBuilderListItemFatory. Such case has already been described in the prior two sections.</p>
<p>It will be used in the next section to build GtkListItem in GtkColumnView, which is the most useful view object for GListModel.</p>
<h2 id="compilation-and-execution">Compilation and execution</h2>
<p>All the sources are in src/expression directory. Change your current directory to the directory and run meson and ninja. Then, execute the application.</p>
<pre><code>$ meson _build
$ ninja -C _build
$ build/exp</code></pre>
<p>Then, two windows appear.</p>
<figure>
<img src="image/expression.png" alt="" /><figcaption>Expression</figcaption>
</figure>
<p>If you put some text in the field of the entry, then the same text appears in the second GtkLabel. Because the “label” property of the second GtkLabel instance is bound to the text in the GtkEntryBuffer.</p>
<p>If you resize the window, then the size appears in the title bar because the “title” property is bound to “default-width” and “default-height” properties.</p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  </body>
  </html>
